/**
 * TimePulse AI - Sistema de Gest√£o para Restaurantes
 * Arquivo: js/app.js
 * Descri√ß√£o: JavaScript principal com integra√ß√£o Supabase e todas as funcionalidades
 */

// ===== VARI√ÅVEIS GLOBAIS =====
let supabaseClient = null;
let currentUser = null;
let currentRestaurant = null;
let realtimeSubscriptions = [];

// ===== INICIALIZA√á√ÉO DO SISTEMA =====
document.addEventListener('DOMContentLoaded', async function() {
    console.log('üöÄ Inicializando TimePulse AI...');
    
    try {
        // Verificar se config.js foi carregado
        if (!window.CONFIG) {
            throw new Error('Arquivo de configura√ß√£o (config.js) n√£o foi carregado');
        }
        
        // Inicializar Supabase
        await initializeSupabase();
        
        // Verificar autentica√ß√£o
        await checkAuthentication();
        
        // Configurar p√°gina espec√≠fica
        setupCurrentPage();
        
        console.log('‚úÖ TimePulse AI carregado e pronto para uso!');
        
    } catch (error) {
        console.error('‚ùå Erro na inicializa√ß√£o:', error);
        showGlobalError('Erro de inicializa√ß√£o do sistema');
    }
});

// ===== CONFIGURA√á√ÉO DO SUPABASE =====
async function initializeSupabase() {
    try {
        console.log('üîß Inicializando Supabase...');
        
        if (typeof window.supabase === 'undefined') {
            throw new Error('Biblioteca Supabase n√£o carregada');
        }
        
        if (!window.CONFIG.SUPABASE_URL || !window.CONFIG.SUPABASE_ANON_KEY) {
            throw new Error('Credenciais do Supabase n√£o encontradas no config.js');
        }
        
        if (window.CONFIG.SUPABASE_URL.includes('YOUR_SUPABASE_URL') || 
            window.CONFIG.SUPABASE_ANON_KEY.includes('YOUR_SUPABASE_ANON_KEY')) {
            throw new Error('Configure as credenciais reais no arquivo config.js');
        }
        
        supabaseClient = window.supabase.createClient(
            window.CONFIG.SUPABASE_URL,
            window.CONFIG.SUPABASE_ANON_KEY
        );
        
        if (!supabaseClient) {
            throw new Error('Falha ao criar cliente Supabase');
        }
        
        // Configurar listener de mudan√ßas de autentica√ß√£o
        supabaseClient.auth.onAuthStateChange(async (event, session) => {
            console.log('üîÑ Estado de autentica√ß√£o mudou:', event);
            await handleAuthStateChange(event, session);
        });
        
        console.log('‚úÖ Supabase inicializado com sucesso');
        console.log('üìç URL:', window.CONFIG.SUPABASE_URL);
        
    } catch (error) {
        console.error('‚ùå Erro ao inicializar Supabase:', error);
        throw error;
    }
}

// ===== GERENCIAMENTO DE AUTENTICA√á√ÉO =====
async function checkAuthentication() {
    try {
        const { data: { user }, error } = await supabaseClient.auth.getUser();
        
        if (error) {
            console.warn('‚ö†Ô∏è Erro ao verificar usu√°rio:', error);
            return false;
        }
        
        if (user) {
            currentUser = user;
            
            // Verificar se o email foi confirmado
            if (!user.email_confirmed_at) {
                console.log('üìß Email n√£o confirmado');
                
                // Redirecionar apenas se n√£o estiver nas p√°ginas de confirma√ß√£o
                const currentPage = getCurrentPageName();
                if (!['email-confirmation', 'auth-success', 'login', 'cadastro_restaurante', 'index'].includes(currentPage)) {
                    window.location.href = 'email-confirmation.html';
                }
                return false;
            }
            
            // Carregar dados do restaurante
            await loadRestaurantData();
            
            // Configurar atualiza√ß√µes em tempo real
            setupRealtimeSubscriptions();
            
            console.log('‚úÖ Usu√°rio autenticado:', user.email);
            return true;
        } else {
            console.log('üë§ Usu√°rio n√£o autenticado');
            
            // Redirecionar para login se n√£o estiver em p√°ginas p√∫blicas
            const currentPage = getCurrentPageName();
            if (!['login', 'cadastro_restaurante', 'index', 'email-confirmation', 'reset-password', 'auth-success'].includes(currentPage)) {
                window.location.href = 'login.html';
            }
            return false;
        }
        
    } catch (error) {
        console.error('‚ùå Erro na verifica√ß√£o de autentica√ß√£o:', error);
        return false;
    }
}

// ===== CARREGAMENTO DE DADOS DO RESTAURANTE =====
async function loadRestaurantData() {
    try {
        if (!currentUser) return;
        
        const { data: restaurants, error } = await supabaseClient
            .from('restaurants')
            .select('*')
            .eq('owner_id', currentUser.id)
            .single();
        
        if (error) {
            console.warn('‚ö†Ô∏è Restaurante n√£o encontrado:', error);
            
            // Se estiver no dashboard, redirecionar para cadastro
            const currentPage = getCurrentPageName();
            if (currentPage === 'dashboard') {
                window.location.href = 'cadastro_restaurante.html';
            }
            return;
        }
        
        currentRestaurant = restaurants;
        console.log('üè™ Restaurante carregado:', restaurants.name);
        
        // Atualizar UI com dados do restaurante
        updateRestaurantUI();
        
    } catch (error) {
        console.error('‚ùå Erro ao carregar dados do restaurante:', error);
    }
}

// ===== CONFIGURA√á√ÉO DA P√ÅGINA ATUAL =====
function setupCurrentPage() {
    const currentPage = getCurrentPageName();
    console.log('üìÑ Configurando p√°gina:', currentPage);
    
    switch (currentPage) {
        case 'dashboard':
            setupDashboard();
            break;
        case 'gestao_pedidos':
            setupPedidos();
            break;
        case 'gestao_entregadores':
            setupEntregadores();
            break;
        case 'configuracoes':
            setupConfiguracoes();
            break;
        case 'relatorios':
            setupRelatorios();
            break;
        default:
            console.log('P√°gina padr√£o, sem configura√ß√£o espec√≠fica');
    }
}

// ===== CONFIGURA√á√ÉO DO DASHBOARD =====
function setupDashboard() {
    if (typeof window.DashboardManager !== 'undefined') {
        window.dashboardManager = new DashboardManager();
    }
}

// ===== CONFIGURA√á√ÉO DE PEDIDOS =====
function setupPedidos() {
    if (typeof window.PedidosManager !== 'undefined') {
        window.pedidosManager = new PedidosManager();
    }
}

// ===== CONFIGURA√á√ÉO DE ENTREGADORES =====
function setupEntregadores() {
    if (typeof window.EntregadoresManager !== 'undefined') {
        window.entregadoresManager = new EntregadoresManager();
    }
}

// ===== CONFIGURA√á√ÉO DE CONFIGURA√á√ïES =====
function setupConfiguracoes() {
    if (typeof window.ConfiguracoesManager !== 'undefined') {
        window.configuracoesManager = new ConfiguracoesManager();
    }
}

// ===== CONFIGURA√á√ÉO DE RELAT√ìRIOS =====
function setupRelatorios() {
    if (typeof window.RelatoriosManager !== 'undefined') {
        window.relatoriosManager = new RelatoriosManager();
    }
}

// ===== ATUALIZA√á√ïES EM TEMPO REAL =====
function setupRealtimeSubscriptions() {
    if (!supabaseClient || !currentRestaurant) return;
    
    try {
        // Subscription para pedidos
        const pedidosSubscription = supabaseClient
            .channel('pedidos_changes')
            .on('postgres_changes', {
                event: '*',
                schema: 'public',
                table: 'orders',
                filter: `restaurant_id=eq.${currentRestaurant.id}`
            }, (payload) => {
                console.log('üîî Novo evento de pedido:', payload);
                handleOrderUpdate(payload);
            })
            .subscribe();
        
        realtimeSubscriptions.push(pedidosSubscription);
        
        console.log('‚úÖ Atualiza√ß√µes em tempo real configuradas');
        
    } catch (error) {
        console.error('‚ùå Erro ao configurar tempo real:', error);
    }
}

// ===== MANIPULADOR DE ATUALIZA√á√ïES DE PEDIDOS =====
function handleOrderUpdate(payload) {
    // Disparar evento customizado para outros m√≥dulos
    const event = new CustomEvent('orderUpdate', { detail: payload });
    document.dispatchEvent(event);
    
    // Atualizar notifica√ß√µes
    updateNotifications();
}

// ===== MANIPULADOR DE MUDAN√áAS DE AUTENTICA√á√ÉO =====
async function handleAuthStateChange(event, session) {
    switch (event) {
        case 'SIGNED_IN':
            console.log('‚úÖ Usu√°rio logado');
            currentUser = session.user;
            await loadRestaurantData();
            break;
            
        case 'SIGNED_OUT':
            console.log('üëã Usu√°rio deslogado');
            currentUser = null;
            currentRestaurant = null;
            
            // Limpar subscriptions
            realtimeSubscriptions.forEach(sub => sub.unsubscribe());
            realtimeSubscriptions = [];
            
            // Redirecionar para login
            if (getCurrentPageName() !== 'login') {
                window.location.href = 'login.html';
            }
            break;
    }
}

// ===== ATUALIZA√á√ÉO DA UI DO RESTAURANTE =====
function updateRestaurantUI() {
    if (!currentRestaurant) return;
    
    // Atualizar nome do restaurante na sidebar
    const restaurantNameElements = document.querySelectorAll('[id*="restaurantName"], .restaurant-name');
    restaurantNameElements.forEach(element => {
        if (element) element.textContent = currentRestaurant.name;
    });
    
    // Atualizar cor prim√°ria se configurada
    if (currentRestaurant.primary_color) {
        document.documentElement.style.setProperty('--primary-color', currentRestaurant.primary_color);
    }
}

// ===== ATUALIZA√á√ÉO DE NOTIFICA√á√ïES =====
function updateNotifications() {
    // Implementar sistema de notifica√ß√µes
    console.log('üîî Atualizando notifica√ß√µes...');
}

// ===== UTILIT√ÅRIOS =====
function getCurrentPageName() {
    const path = window.location.pathname;
    const page = path.split('/').pop();
    return page.replace('.html', '') || 'index';
}

// ===== MANIPULA√á√ÉO DE ERROS GLOBAIS =====
function showGlobalError(message) {
    console.error('‚ùå Erro:', message);
    
    // Criar ou atualizar elemento de erro
    let errorElement = document.getElementById('global-error');
    if (!errorElement) {
        errorElement = document.createElement('div');
        errorElement.id = 'global-error';
        errorElement.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #dc3545;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            z-index: 10000;
            max-width: 300px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        `;
        document.body.appendChild(errorElement);
    }
    
    errorElement.textContent = message;
    
    // Remover ap√≥s 5 segundos
    setTimeout(() => {
        if (errorElement.parentNode) {
            errorElement.parentNode.removeChild(errorElement);
        }
    }, 5000);
}

// ===== LOGOUT =====
async function logout() {
    try {
        const { error } = await supabaseClient.auth.signOut();
        if (error) {
            console.error('‚ùå Erro no logout:', error);
            return;
        }
        
        console.log('üëã Logout realizado com sucesso');
        window.location.href = 'login.html';
        
    } catch (error) {
        console.error('‚ùå Erro no logout:', error);
    }
}

// ===== CONFIGURAR EVENTOS GLOBAIS =====
document.addEventListener('click', function(e) {
    // Logout buttons
    if (e.target.matches('#logoutBtn, .logout-btn, [data-action="logout"]')) {
        e.preventDefault();
        logout();
    }
    
    // Sidebar toggle
    if (e.target.matches('[data-action="toggle-sidebar"]')) {
        e.preventDefault();
        document.body.classList.toggle('sidebar-collapsed');
    }
});

// ===== DISPONIBILIZAR GLOBALMENTE =====
window.TimePulseAI = {
    supabase: () => supabaseClient,
    currentUser: () => currentUser,
    currentRestaurant: () => currentRestaurant,
    logout: logout,
    showGlobalError: showGlobalError
};